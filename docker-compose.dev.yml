version: '3.9'

services:
  uploader-client-dev:
    profiles:
      - uploader
    build:
      context: ./uploader/client
      target: client-build
      args:
        BASE_TAG: ${DOCKER_TAG}
        REGISTRY_NAMESPACE: ${REGISTRY_NAMESPACE}
    networks:
      - internal
    volumes:
      - ./uploader/client:/usr/src/app
      - ./configs:/configs
    environment:
      - DEV_MODE
      - UPLOADER_API_BASE_URL=https://api-uploader.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - CLIENT_ID=${UPLOADER_CLIENT_ID}
      - CLIENT_RANDOM_ID=${UPLOADER_CLIENT_RANDOM_ID}
      - CLIENT_SECRET=${UPLOADER_CLIENT_SECRET}
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - WDS_SOCKET_PORT=443
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uploader-client-dev.rule=Host(`uploader.${PHRASEA_DOMAIN}`)"

  expose-client-dev:
    profiles:
      - expose
    build:
      context: ./expose/client
      target: client-build
      args:
        BASE_TAG: ${DOCKER_TAG}
        REGISTRY_NAMESPACE: ${REGISTRY_NAMESPACE}
    networks:
      - internal
    volumes:
      - ./expose/client:/usr/src/app
      - ./configs:/configs
    environment:
      - EXPOSE_API_BASE_URL=https://api-expose.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - CLIENT_ID=${EXPOSE_CLIENT_ID}
      - CLIENT_RANDOM_ID=${EXPOSE_CLIENT_RANDOM_ID}
      - CLIENT_SECRET=${EXPOSE_CLIENT_SECRET}
      - MATOMO_HOST
      - EXPOSE_REQUEST_SIGNATURE_TTL
      - WDS_SOCKET_PORT=443
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.expose-client-dev.rule=Host(`expose.${PHRASEA_DOMAIN}`)"

  databox-client-dev:
    profiles:
      - databox
    build:
      context: ./databox/client
      target: client-build
      args:
        BASE_TAG: ${DOCKER_TAG}
        REGISTRY_NAMESPACE: ${REGISTRY_NAMESPACE}
    networks:
      - internal
    volumes:
      - ./databox/client:/usr/src/app
      - ./configs:/configs
    environment:
      - DEV_MODE
      - DATABOX_API_BASE_URL=https://api-databox.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - UPLOADER_API_BASE_URL=https://api-uploader.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - DATABOX_REQUEST_SIGNATURE_TTL
      - CLIENT_ID=${DATABOX_CLIENT_ID}
      - CLIENT_RANDOM_ID=${DATABOX_CLIENT_RANDOM_ID}
      - CLIENT_SECRET=${DATABOX_CLIENT_SECRET}
      - MATOMO_HOST
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - WDS_SOCKET_PORT=443
      - UPLOADER_TARGET_SLUG=${DATABOX_UPLOADER_TARGET_SLUG}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.databox-client-dev.rule=Host(`databox.${PHRASEA_DOMAIN}`)"

  expose-api-php:
    environment:
      - XDEBUG_ENABLED
      - XDEBUG_CONFIG=remote_host=${PS_GATEWAY_IP} idekey=${IDE_KEY} remote_enable=1
      - PHP_IDE_CONFIG=serverName=${PS_DEBUG_SERVER_NAME_PREFIX}expose
    volumes:
      - ./expose/api:/srv/app

  expose-api-nginx:
    volumes:
      - ./expose/api/public:/srv/app/public
      - ./expose/api/docker/nginx/tpl:/etc/nginx/tpl
      - ./expose/api/docker/nginx/entrypoint.sh:/entrypoint.sh

  expose-worker:
    volumes:
      - ./expose/api:/srv/app
      - ./expose/api/docker/supervisor:/etc/supervisor.d

  uploader-api-php:
    environment:
      - XDEBUG_ENABLED
      - XDEBUG_CONFIG=remote_host=${PS_GATEWAY_IP} idekey=${IDE_KEY} remote_enable=1
      - PHP_IDE_CONFIG=serverName=${PS_DEBUG_SERVER_NAME_PREFIX}uploader
    volumes:
      - ./uploader/api:/srv/app

  uploader-worker:
    command: [ "/bin/sh", "-c", "exit" ]
    volumes:
      - ./uploader/api:/srv/app
      - ./uploader/api/docker/supervisor:/etc/supervisor.d

  uploader-api-nginx:
    volumes:
      - ./uploader/api/public:/srv/app/public

  auth-worker:
    command: [ "/bin/sh", "-c", "exit" ]
    volumes:
      - ./auth/api:/srv/app
      - ./auth/api/docker/supervisor:/etc/supervisor.d

  auth-api-php:
    environment:
      - XDEBUG_ENABLED
      - XDEBUG_CONFIG=remote_host=${PS_GATEWAY_IP} idekey=${IDE_KEY} remote_enable=1
      - PHP_IDE_CONFIG=serverName=${PS_DEBUG_SERVER_NAME_PREFIX}auth
    volumes:
      - ./auth/api:/srv/app

  auth-api-nginx:
    volumes:
      - ./auth/api/public:/srv/app/public

  notify-api-php:
    environment:
      - XDEBUG_ENABLED
      - XDEBUG_CONFIG=remote_host=${PS_GATEWAY_IP} idekey=${IDE_KEY} remote_enable=1
      - PHP_IDE_CONFIG=serverName=${PS_DEBUG_SERVER_NAME_PREFIX}notify
    volumes:
      - ./notify/api:/srv/app

  notify-api-nginx:
    volumes:
      - ./notify/api/public:/srv/app/public

  notify-worker:
    command: [ "/bin/sh", "-c", "exit" ]
    volumes:
      - ./notify/api:/srv/app
      - ./notify/api/docker/supervisor:/etc/supervisor.d

  databox-api-php:
    environment:
      - XDEBUG_ENABLED
      - XDEBUG_CONFIG=remote_host=${PS_GATEWAY_IP} idekey=${IDE_KEY} remote_enable=1
      - PHP_IDE_CONFIG=serverName=${PS_DEBUG_SERVER_NAME_PREFIX}databox
    volumes:
      - ./databox/api:/srv/app

  databox-api-nginx:
    volumes:
      - ./databox/api/public:/srv/app/public

  databox-worker:
    command: [ "/bin/sh", "-c", "exit" ]
    volumes:
      - ./databox/api:/srv/app
      - ./databox/api/docker/supervisor:/etc/supervisor.d

  elasticsearch:
    ports:
      - ${ELASTICSEARCH_PORT}:9200

  dev:
    build: infra/docker/dev
    networks:
      - internal
    stdin_open: true
    tty: true
    hostname: local
    environment:
      - APP_ENV
      - SSH_AUTH_SOCK=/ssh-auth-sock
      - UPLOADER_API_BASE_URL=https://api-uploader.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - DATABOX_API_BASE_URL=https://api-databox.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - MARIADB_NAME=databox
      - MARIADB_USER=root
      - MARIADB_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_HOST
      - MARIADB_PORT
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - ELASTICSEARCH_URL
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${UPLOADER_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - EXPOSE_API_BASE_URL=https://api-expose.${PHRASEA_DOMAIN}${HTTPS_PORT_PREFIX}
      - REPORT_API_BASE_URL
      - UPLOADER_REQUEST_SIGNATURE_TTL
      - EXPOSE_REQUEST_SIGNATURE_TTL
      - MAPBOX_TOKEN
      - XDEBUG_ENABLED
      - IDE_KEY
      - XDEBUG_REMOTE_HOST=${PS_GATEWAY_IP}
      - PHP_IDE_CONFIG=serverName=${PS_DEBUG_SERVER_NAME_PREFIX}cli
      - PHRASEANET_APP_OAUTH_TOKEN
      - PHRASEANET_BASE_URL
      - VERIFY_SSL
    working_dir: /var/workspace
    volumes:
      - ./:/var/workspace
      - ${SSH_AUTH_SOCK}:/ssh-auth-sock
      - ${HOME}/.ssh:/home/app/.ssh
      - dev_vol:/home/app
      - ./configs:/configs
    extra_hosts:
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-uploader.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-expose.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-databox.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-notify.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - phraseanet.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  report-api:
    volumes:
      - ./report/src:/usr/app

  dashboard:
    volumes:
    - ./dashboard/docker/root/entrypoint.sh:/entrypoint.sh
    - ./dashboard/src:/var/app
    - ./dashboard/src/public:/usr/share/nginx/html

  databox-watcher:
    command: ["yarn", "start:dev"]
    volumes:
      - ./databox/indexer:/usr/app

  databox-indexer:
    volumes:
      - ./databox/indexer:/usr/app

  db:
    ports:
      - 127.0.0.1:${DB_DEV_PORT}:5432

volumes:
  dev_vol:
    driver: local
