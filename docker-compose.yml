version: '3.4'

networks:
  internal:

services:
  upload_php:
    image: alchemy/upload_php
    build:
      context: upload
      target: upload_php
    networks:
      internal:
        aliases:
          - upload
    environment:
      - APP_ENV

  upload_nginx:
    image: alchemy/upload_nginx
    build:
      context: ./upload
      target: upload_nginx
    networks:
      - internal
    ports:
      - ${UPLOAD_PORT}:80
    depends_on:
      - upload_php

  client:
    image: alchemy/client_nginx
    build:
      args:
        - UPLOAD_BASE_URL=http://localhost:8080
      context: ./client
      target: client_nginx
    ports:
      - ${CLIENT_PORT}:80
    networks:
      - internal

  auth_php:
    image: alchemy/auth_php
    build:
      context: auth
      target: auth_php
    networks:
      internal:
        aliases:
          - auth
    depends_on:
      - db
    environment:
      - APP_ENV
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}

  auth_nginx:
    image: alchemy/auth_nginx
    build:
      context: ./auth
      target: auth_nginx
    networks:
      - internal
    ports:
      - ${AUTH_PORT}:80
    depends_on:
      - auth_php

  db:
    image: postgres:11.2-alpine
    networks:
      - internal
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
