version: '3.4'

networks:
  internal:

services:
  uploader_api_php:
    image: ${REGISTRY_NAMESPACE}uploader_api_php:$DOCKER_TAG
    build:
      context: ./uploader/api
      target: uploader_api_php
    networks:
      internal:
        aliases:
          - uploader_api
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - ASSET_CONSUMER_COMMIT_URI
      - ASSET_CONSUMER_ACCESS_TOKEN
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - UPLOAD_BASE_URL
      - UPLOAD_TEMP_DIR=/var/data/upload
      - AUTH_CLIENT_ID=${UPLOAD_ADMIN_CLIENT_ID}
      - AUTH_CLIENT_RANDOM_ID=${UPLOAD_ADMIN_CLIENT_RANDOM_ID}
      - AUTH_CLIENT_SECRET=${UPLOAD_ADMIN_CLIENT_SECRET}
    volumes:
      - uploader_vol:/var/data/upload

  uploader_worker:
    image: ${REGISTRY_NAMESPACE}uploader_worker:$DOCKER_TAG
    build:
      context: ./uploader/api
      target: uploader_worker
    networks:
      - internal
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - ASSET_CONSUMER_COMMIT_URI
      - ASSET_CONSUMER_ACCESS_TOKEN
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - UPLOAD_BASE_URL
      - UPLOAD_TEMP_DIR=/var/data/upload
    volumes:
      - uploader_vol:/var/data/upload

  uploader_api_nginx:
    image: ${REGISTRY_NAMESPACE}uploader_api_nginx:$DOCKER_TAG
    build:
      context: ./uploader/api
      target: uploader_api_nginx
    networks:
      - internal
    ports:
      - ${UPLOAD_PORT}:80
    depends_on:
      - uploader_api_php

  uploader_client:
    image: ${REGISTRY_NAMESPACE}uploader_client:$DOCKER_TAG
    build:
      context: ./uploader/client
      target: uploader_client_nginx
    volumes:
      - ./configs:/configs
    ports:
      - ${CLIENT_PORT}:80
    networks:
      - internal
    environment:
      - DEV_MODE
      - UPLOAD_BASE_URL
      - SIGN_UP_URL
      - AUTH_BASE_URL
      - CLIENT_ID=${CLIENT_ID}_${CLIENT_RANDOM_ID}
      - CLIENT_SECRET
      - CLIENT_LOGO_SRC
      - CLIENT_LOGO_X_MARGIN
      - CLIENT_LOGO_Y_MARGIN

  auth_worker:
    image: ${REGISTRY_NAMESPACE}auth_worker:$DOCKER_TAG
    build:
      context: ./auth/api
      target: auth_worker
    networks:
      - internal
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - AUTH_BASE_URL
      - REGISTRATION_VALIDATE_EMAIL=${AUTH_REGISTRATION_VALIDATE_EMAIL}
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}

  auth_api_php:
    image: ${REGISTRY_NAMESPACE}auth_api_php:$DOCKER_TAG
    build:
      context: ./auth/api
      target: auth_api_php
    networks:
      internal:
        aliases:
          - auth_api
    environment:
      - APP_ENV
      - AUTH_BASE_URL
      - REGISTRATION_VALIDATE_EMAIL=${AUTH_REGISTRATION_VALIDATE_EMAIL}
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - MAILER_URL
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - ./configs:/configs
    depends_on:
      - redis
      - rabbitmq
      - db

  auth_api_nginx:
    image: ${REGISTRY_NAMESPACE}auth_api_nginx:$DOCKER_TAG
    build:
      context: ./auth/api
      target: auth_api_nginx
    networks:
      internal:
        aliases:
          - auth
    ports:
      - ${AUTH_PORT}:80
    depends_on:
      - auth_api_php

  redis:
    image: redis:5.0.5-alpine
    networks:
      - internal
    volumes:
      - redis_vol:/data

  db:
    image: postgres:11.2-alpine
    hostname: postgres
    networks:
      - internal
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    volumes:
      - db_vol:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3.7.14-management
    networks:
      - internal
    environment:
      - RABBITMQ_DEFAULT_USER
      - RABBITMQ_DEFAULT_PASS
    ports:
      - ${RABBITMQ_MGT_PORT}:15672

  dockerize:
    image: jwilder/dockerize
    networks:
      - internal
    command: ["dockerize", "-wait", "tcp://db:5432", "-wait", "tcp://rabbitmq:5672", "-timeout", "50s", "--", "echo", "ready"]

  expose_api_php:
    image: ${REGISTRY_NAMESPACE}expose_api_php:$DOCKER_TAG
    build:
      context: ./expose/api
      target: expose_api_php
    networks:
      internal:
        aliases:
          - expose
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - STORAGE_BUCKET_NAME=${EXPOSE_STORAGE_BUCKET_NAME}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY

  expose_worker:
    image: ${REGISTRY_NAMESPACE}expose_worker:$DOCKER_TAG
    build:
      context: ./expose/api
      target: expose_worker
    networks:
      - internal
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - STORAGE_BUCKET_NAME=${EXPOSE_STORAGE_BUCKET_NAME}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY

  expose_api_nginx:
    image: ${REGISTRY_NAMESPACE}expose_api_nginx:$DOCKER_TAG
    build:
      context: ./expose/api
      target: expose_api_nginx
    networks:
      - internal
    ports:
      - ${EXPOSE_PORT}:80
    depends_on:
      - expose_api_php

  minio:
    image: minio/minio
    networks:
      - internal
    command: server /data
    volumes:
      - s3_vol:/data
    environment:
      MINIO_ACCESS_KEY: ${S3_STORAGE_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_STORAGE_SECRET_KEY}

  minio_mc:
    image: minio/mc
    networks:
      - internal
    command: exit 0
    depends_on:
      - minio
    environment:
      MINIO_ACCESS_KEY: ${S3_STORAGE_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_STORAGE_SECRET_KEY}

volumes:
  db_vol:
  redis_vol:
  uploader_vol:
  s3_vol:
