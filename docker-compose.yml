version: '3.9'

networks:
  internal:
    driver: bridge
    ipam:
      config:
        - subnet: ${PS_SUBNET}

services:
  traefik:
    image: traefik:v2.5.5
    networks:
      - internal
    ports:
      - ${TRAEFIK_HTTPS_PORT}:443
      - ${TRAEFIK_HTTP_PORT}:80
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infra/traefik/dynamic_conf.yaml:/etc/traefik/dynamic_conf.yaml:ro
      - ./infra/traefik/letsencrypt:/etc/traefik/letsencrypt
      - ./infra/certs:/etc/traefik/certs:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-console.rule=Host(`traefik-console.${PHRASEA_DOMAIN}`)"
      - "traefik.http.services.traefik-console.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.admin-secured.basicauth.realm=Secured"
      - "traefik.http.middlewares.admin-secured.basicauth.users=${ADMIN_BASIC_AUTH_USER}"
      - "traefik.http.routers.traefik-console.middlewares=admin-secured@docker"
    environment:
      - TRAEFIK_API=true
      - TRAEFIK_API_INSECURE=true
      - TRAEFIK_ACCESSLOG=true
      - TRAEFIK_LOG_LEVEL=DEBUG
      - TRAEFIK_LOG_FORMAT=common
      - TRAEFIK_PROVIDERS_DOCKER=true
      - TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT=false
      - TRAEFIK_ENTRYPOINTS_WEB=true
      - TRAEFIK_ENTRYPOINTS_WEB_ADDRESS=:80
      - TRAEFIK_ENTRYPOINTS_WEB_HTTP_REDIRECTIONS_ENTRYPOINT_TO=websecure
      - TRAEFIK_ENTRYPOINTS_WEB_HTTP_REDIRECTIONS_ENTRYPOINT_SCHEME=https
      - TRAEFIK_ENTRYPOINTS_WEBSECURE=true
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_HTTP_TLS=true
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_ADDRESS=:443
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_HTTP_TLS_CERTRESOLVER=letsencrypt
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_HTTP_TLS_DOMAINS_0_MAIN=${PHRASEA_DOMAIN}
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_HTTP_TLS_DOMAINS_0_SANS=*.${PHRASEA_DOMAIN}
      - TRAEFIK_PROVIDERS_FILE_FILENAME
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT=${LETS_ENCRYPT_ENABLED}
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=${LETS_ENCRYPT_CONTACT_EMAIL}
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_DNSCHALLENGE_PROVIDER=${LETS_ENCRYPT_PROVIDER}
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_CASERVER=${LETS_ENCRYPT_CA_SERVER}
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_DNSCHALLENGE_DELAYBEFORECHECK=10
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_STORAGE=/etc/traefik/letsencrypt/acme.json
      - GANDIV5_API_KEY
      - OVH_ENDPOINT
      - OVH_APPLICATION_KEY
      - OVH_APPLICATION_SECRET
      - OVH_CONSUMER_KEY

  uploader-api-php:
    profiles:
      - uploader
    image: ${REGISTRY_NAMESPACE}uploader-api-php:$DOCKER_TAG
    build:
      context: ./uploader/api
      target: uploader-api-php
    networks:
      internal:
        aliases:
          - uploader-api-php
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - TRUSTED_PROXIES
      - VERIFY_SSL
      - APP_ID=uploader
      - ASSET_CONSUMER_COMMIT_URI
      - ASSET_CONSUMER_ACCESS_TOKEN
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - UPLOADER_API_BASE_URL=https://api-uploader.${PHRASEA_DOMAIN}
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - ADMIN_CLIENT_ID=${UPLOADER_ADMIN_CLIENT_ID}
      - ADMIN_CLIENT_RANDOM_ID=${UPLOADER_ADMIN_CLIENT_RANDOM_ID}
      - ADMIN_CLIENT_SECRET=${UPLOADER_ADMIN_CLIENT_SECRET}
      - REPORT_API_BASE_URL
      - UPLOAD_MAX_FILE_SIZE
      - UPLOADER_REQUEST_SIGNATURE_TTL
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${UPLOADER_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${UPLOADER_STORAGE_BUCKET_NAME}
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}
      - DELETE_ASSET_GRACEFUL_TIME=${UPLOADER_DELETE_ASSET_GRACEFUL_TIME}
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=uploader-api
    volumes:
      - uploader_vol:/var/data/upload
      - ./configs:/configs
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  uploader-worker:
    profiles:
      - uploader
    image: ${REGISTRY_NAMESPACE}uploader-worker:$DOCKER_TAG
    build:
      context: ./uploader/api
      target: uploader-worker
    networks:
      - internal
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - APP_ID=uploader
      - ASSET_CONSUMER_COMMIT_URI
      - ASSET_CONSUMER_ACCESS_TOKEN
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - UPLOADER_API_BASE_URL=https://api-uploader.${PHRASEA_DOMAIN}
      - REPORT_API_BASE_URL
      - UPLOADER_REQUEST_SIGNATURE_TTL
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${UPLOADER_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${UPLOADER_STORAGE_BUCKET_NAME}
      - DELETE_ASSET_GRACEFUL_TIME=${UPLOADER_DELETE_ASSET_GRACEFUL_TIME}
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=uploader-worker
    volumes:
      - uploader_vol:/var/data/upload
      - ./configs:/configs
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  uploader-api-nginx:
    profiles:
      - uploader
    image: ${REGISTRY_NAMESPACE}uploader-api-nginx:$DOCKER_TAG
    build:
      context: ./uploader/api
      target: uploader-api-nginx
    environment:
      - UPLOAD_MAX_FILE_SIZE
    networks:
      internal:
        aliases:
          - uploader-api
    depends_on:
      - uploader-api-php
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uploader-api.rule=Host(`api-uploader.${PHRASEA_DOMAIN}`)"

  auth-worker:
    profiles:
      - auth
      - databox
      - expose
      - notify
      - uploader
    image: ${REGISTRY_NAMESPACE}auth-worker:$DOCKER_TAG
    build:
      context: ./auth/api
      target: auth-worker
    networks:
      - internal
    depends_on:
      - rabbitmq
      - db
    volumes:
      - ./configs:/configs
    environment:
      - APP_ENV
      - APP_ID=auth
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - REGISTRATION_VALIDATE_EMAIL=${AUTH_REGISTRATION_VALIDATE_EMAIL}
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - REPORT_API_BASE_URL
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=auth-worker

  auth-api-php:
    profiles:
      - auth
      - databox
      - expose
      - notify
      - uploader
    image: ${REGISTRY_NAMESPACE}auth-api-php:$DOCKER_TAG
    build:
      context: ./auth/api
      target: auth-api-php
    networks:
      internal:
        aliases:
          - auth-api-php
    environment:
      - APP_ENV
      - TRUSTED_PROXIES
      - VERIFY_SSL
      - APP_ID=auth
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - ADMIN_CLIENT_ID=${AUTH_ADMIN_CLIENT_ID}
      - ADMIN_CLIENT_RANDOM_ID=${AUTH_ADMIN_CLIENT_RANDOM_ID}
      - ADMIN_CLIENT_SECRET=${AUTH_ADMIN_CLIENT_SECRET}
      - REGISTRATION_VALIDATE_EMAIL=${AUTH_REGISTRATION_VALIDATE_EMAIL}
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - REPORT_API_BASE_URL
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=auth-api
    volumes:
      - ./configs:/configs
    depends_on:
      - redis
      - rabbitmq
      - db
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  auth-api-nginx:
    profiles:
      - auth
      - databox
      - expose
      - notify
      - uploader
    image: ${REGISTRY_NAMESPACE}auth-api-nginx:$DOCKER_TAG
    build:
      context: ./auth/api
      target: auth-api-nginx
    networks:
      internal:
        aliases:
          - auth-api
    depends_on:
      - auth-api-php
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-api.rule=Host(`api-auth.${PHRASEA_DOMAIN}`)"

  expose-api-php:
    profiles:
      - expose
    image: ${REGISTRY_NAMESPACE}expose-api-php:$DOCKER_TAG
    build:
      context: ./expose/api
      target: expose-api-php
    networks:
      internal:
        aliases:
          - expose-api-php
    volumes:
      - ./configs:/configs
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - DEV_MODE
      - TRUSTED_PROXIES
      - VERIFY_SSL
      - APP_ID=expose
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - EXPOSE_REQUEST_SIGNATURE_TTL
      - ADMIN_CLIENT_ID=${EXPOSE_ADMIN_CLIENT_ID}
      - ADMIN_CLIENT_RANDOM_ID=${EXPOSE_ADMIN_CLIENT_RANDOM_ID}
      - ADMIN_CLIENT_SECRET=${EXPOSE_ADMIN_CLIENT_SECRET}
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${EXPOSE_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${EXPOSE_STORAGE_BUCKET_NAME}
      - REPORT_API_BASE_URL
      - EXPOSE_API_BASE_URL=https://api-expose.${PHRASEA_DOMAIN}
      - EXPOSE_CLIENT_BASE_URL=https://expose.${PHRASEA_DOMAIN}
      - UPLOAD_MAX_FILE_SIZE
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}
      - ZIPPY_CLIENT_ID
      - ZIPPY_CLIENT_SECRET
      - ZIPPY_BASE_URL
      - SIDEBAR_DEFAULT_OPEN=${EXPOSE_SIDEBAR_DEFAULT_OPEN}
      - MAPBOX_TOKEN
      - EXPOSE_CLIENT_LOGO_URL
      - EXPOSE_CLIENT_LOGO_ALT
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=expose-api
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - zippy-svc.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  expose-worker:
    profiles:
      - expose
    image: ${REGISTRY_NAMESPACE}expose-worker:$DOCKER_TAG
    build:
      context: ./expose/api
      target: expose-worker
    networks:
      - internal
    volumes:
      - ./configs:/configs
    depends_on:
      - rabbitmq
      - db
    environment:
      - APP_ENV
      - APP_ID=expose
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${EXPOSE_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${EXPOSE_STORAGE_BUCKET_NAME}
      - EXPOSE_REQUEST_SIGNATURE_TTL
      - REPORT_API_BASE_URL
      - EXPOSE_API_BASE_URL=https://api-expose.${PHRASEA_DOMAIN}
      - UPLOAD_MAX_FILE_SIZE
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=expose-worker
    extra_hosts:
      - zippy-svc.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  expose-api-nginx:
    profiles:
      - expose
    image: ${REGISTRY_NAMESPACE}expose-api-nginx:$DOCKER_TAG
    build:
      context: ./expose/api
      target: expose-api-nginx
    volumes:
      - expose_nginx_cache:/var/cache/nginx
    networks:
      internal:
        aliases:
          - expose_api
    depends_on:
      - expose-api-php
    environment:
      - UPLOAD_MAX_FILE_SIZE
      - PS_SUBNET
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.expose-api.rule=Host(`api-expose.${PHRASEA_DOMAIN}`)"

  notify-api-php:
    profiles:
      - notify
    image: ${REGISTRY_NAMESPACE}notify-api-php:$DOCKER_TAG
    build:
      context: ./notify/api
      target: notify-api-php
    networks:
      internal:
        aliases:
          - notify-api-php
    volumes:
      - ./configs:/configs
    depends_on:
      - rabbitmq
    environment:
      - APP_ENV
      - TRUSTED_PROXIES
      - VERIFY_SSL
      - APP_ID=notify
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - ADMIN_CLIENT_ID=${NOTIFY_ADMIN_CLIENT_ID}
      - ADMIN_CLIENT_RANDOM_ID=${NOTIFY_ADMIN_CLIENT_RANDOM_ID}
      - ADMIN_CLIENT_SECRET=${NOTIFY_ADMIN_CLIENT_SECRET}
      - REPORT_API_BASE_URL
      - MAILER_DSN
      - MAIL_FROM
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=notify-api
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  notify-worker:
    profiles:
      - notify
    image: ${REGISTRY_NAMESPACE}notify-worker:$DOCKER_TAG
    build:
      context: ./notify/api
      target: notify-worker
    networks:
      - internal
    depends_on:
      - rabbitmq
    volumes:
      - ./configs:/configs
    environment:
      - APP_ENV
      - APP_ID=notify
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - REPORT_API_BASE_URL
      - MAILER_DSN
      - MAIL_FROM
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=notify-worker

  notify-api-nginx:
    profiles:
      - notify
    image: ${REGISTRY_NAMESPACE}notify-api-nginx:$DOCKER_TAG
    build:
      context: ./notify/api
      target: notify-api-nginx
    networks:
      internal:
        aliases:
          - notify-api
    depends_on:
      - notify-api-php
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.notify-api.rule=Host(`api-notify.${PHRASEA_DOMAIN}`)"

  redis:
    profiles:
      - db
    image: redis:5.0.5-alpine
    networks:
      - internal
    volumes:
      - redis_vol:/data

  db:
    profiles:
      - db
    image: postgres:11.2-alpine
    hostname: postgres
    networks:
      - internal
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    volumes:
      - db_vol:/var/lib/postgresql/data

  rabbitmq:
    profiles:
      - db
    image: rabbitmq:3.7.14-management
    hostname: rabbitmq
    networks:
      - internal
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_vol:/var/lib/rabbitmq
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq-console.rule=Host(`rabbitmq-console.${PHRASEA_DOMAIN}`)"
      - "traefik.http.services.rabbitmq-console.loadbalancer.server.port=15672"

  dockerize:
    profiles:
      - setup
    image: jwilder/dockerize
    networks:
      - internal
    command:
      - "dockerize"
      - "-wait"
      - "tcp://db:5432"
      - "-wait"
      - "tcp://rabbitmq:5672"
      - "-wait"
      - "http://elasticsearch:9200"
      - "-wait"
      - "tcp://minio:9000"
      - "-timeout"
      - "100s"
      - "--"
      - "echo"
      - "ready"

  minio:
    profiles:
      - db
    image: minio/minio:RELEASE.2021-11-24T23-19-33Z.hotfix.1d85a4563
    networks:
      - internal
    command: server /data --console-address ":9001"
    volumes:
      - s3_vol:/data
    environment:
      - MINIO_ROOT_USER=${S3_STORAGE_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${S3_STORAGE_SECRET_KEY}
      - MINIO_BROWSER_REDIRECT_URL=https://minio-console.${PHRASEA_DOMAIN}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`minio.${PHRASEA_DOMAIN}`)"
      - "traefik.http.routers.minio.service=minio"
      - "traefik.http.services.minio.loadbalancer.server.port=9000"
      - "traefik.http.routers.minio-console.rule=Host(`minio-console.${PHRASEA_DOMAIN}`)"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  minio-mc:
    profiles:
      - setup
    image: minio/mc:RELEASE.2020-09-18T00-13-21Z
    networks:
      - internal
    command: exit 0
    depends_on:
      - minio
    environment:
      MINIO_ACCESS_KEY: ${S3_STORAGE_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_STORAGE_SECRET_KEY}
      EXPOSE_STORAGE_BUCKET_NAME: ${EXPOSE_STORAGE_BUCKET_NAME}
      UPLOADER_STORAGE_BUCKET_NAME: ${UPLOADER_STORAGE_BUCKET_NAME}
      DATABOX_STORAGE_BUCKET_NAME: ${DATABOX_STORAGE_BUCKET_NAME}

  matomo-php:
    profiles:
      - matomo
    image: ${REGISTRY_NAMESPACE}matomo-php:$DOCKER_TAG
    build: ./infra/docker/matomo-php
    networks:
      internal:
        aliases:
          - matomo-php
    depends_on:
      - matomo-db
    environment:
      - MATOMO_DATABASE_HOST=matomo-db
      - MATOMO_DATABASE_USERNAME
      - MATOMO_DATABASE_PASSWORD
      - MATOMO_DATABASE_DBNAME
    volumes:
      - matomo_vol:/var/www/html

  matomo-nginx:
    profiles:
      - matomo
    image: ${REGISTRY_NAMESPACE}matomo-nginx:$DOCKER_TAG
    build: ./infra/docker/matomo-nginx
    networks:
      - internal
    depends_on:
      - matomo-php
    volumes:
      - matomo_vol:/var/www/html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matomo.rule=Host(`matomo.${PHRASEA_DOMAIN}`)"

  matomo-db:
    profiles:
      - matomo
    image: mariadb:10.4.10-bionic
    command:
      - "mysqld"
      - "--max_allowed_packet=64MB"
    networks:
      internal:
        aliases:
          - matomo-db
    environment:
      - MYSQL_ROOT_PASSWORD=$MATOMO_MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE=$MATOMO_DATABASE_DBNAME
      - MYSQL_USER=$MATOMO_DATABASE_USERNAME
      - MYSQL_PASSWORD=$MATOMO_DATABASE_PASSWORD
    volumes:
      - matomodb_vol:/var/lib/mysql

  report-api:
    profiles:
      - report
    image: ${REGISTRY_NAMESPACE}report-api:$DOCKER_TAG
    build: report
    networks:
      internal:
        aliases:
          - report-api
    environment:
      - APP_ENV
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DATABASE=${REPORT_DB_NAME}

  pgadmin:
    profiles:
      - tools
    image: dpage/pgadmin4:6.4
    networks:
      - internal
    environment:
      - PGADMIN_DEFAULT_EMAIL
      - PGADMIN_DEFAULT_PASSWORD
    depends_on:
      - db
    volumes:
      - pgadmin_vol:/var/lib/pgadmin
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.${PHRASEA_DOMAIN}`)"

  phpmyadmin:
    profiles:
      - tools
    image: phpmyadmin/phpmyadmin
    networks:
      - internal
    environment:
      - PMA_HOST=matomo-db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`pma.${PHRASEA_DOMAIN}`)"
      - "traefik.http.routers.phpmyadmin.middlewares=admin-secured@docker"

  mailhog:
    profiles:
      - mailhog
    image: mailhog/mailhog
    networks:
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailhog.rule=Host(`mailhog.${PHRASEA_DOMAIN}`)"
      - "traefik.http.services.mailhog.loadbalancer.server.port=8025"
      - "traefik.http.routers.mailhog.middlewares=admin-secured@docker"

  dashboard:
    profiles:
      - dashboard
    image: ${REGISTRY_NAMESPACE}dashboard:$DOCKER_TAG
    build: dashboard
    networks:
      - internal
    environment:
      - APP_ENV
      - ASSET_CONSUMER_ACCESS_TOKEN
      - ASSET_CONSUMER_COMMIT_URI
      - AUTH_PORT
      - AUTH_REGISTRATION_VALIDATE_EMAIL
      - COMPOSE_PROJECT_NAME
      - DEV_MODE
      - DOCKER_TAG
      - EXPOSE_API_PORT
      - EXPOSE_CLIENT_PORT
      - EXPOSE_STORAGE_BUCKET_NAME
      - IDE_KEY
      - MAILER_DSN
      - MAILHOG_PORT
      - MATOMO_DATABASE_DBNAME
      - MATOMO_HOST
      - MATOMO_MYSQL_ROOT_PASSWORD
      - MATOMO_PORT
      - MINIO_PORT
      - NOTIFY_PORT
      - PGADMIN_PORT
      - PHPMYADMIN_PORT
      - PS_DEBUG_SERVER_NAME_PREFIX
      - PS_GATEWAY_IP
      - PS_SUBNET
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - REGISTRY_NAMESPACE
      - REPORT_DB_NAME
      - UPLOADER_API_PORT
      - XDEBUG_ENABLED
      - UPLOADER_API_BASE_URL
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - EXPOSE_API_BASE_URL=https://api-expose.${PHRASEA_DOMAIN}
      - EXPOSE_CLIENT_BASE_URL=https://expose.${PHRASEA_DOMAIN}
      - UPLOADER_CLIENT_BASE_URL=https://uploader.${PHRASEA_DOMAIN}
      - DATABOX_CLIENT_BASE_URL=https://databox.${PHRASEA_DOMAIN}
      - NOTIFY_API_BASE_URL=https://api-notify.${PHRASEA_DOMAIN}
      - DATABOX_API_BASE_URL=https://api-databox.${PHRASEA_DOMAIN}
      - REPORT_API_BASE_URL
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}
      - ZIPPY_BASE_URL=https://zippy.${PHRASEA_DOMAIN}
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - PGADMIN_BASE_URL=https://pgadmin.${PHRASEA_DOMAIN}
      - PHPMYADMIN_BASE_URL=https://pma.${PHRASEA_DOMAIN}
      - RABBITMQ_CONSOLE_BASE_URL=https://rabbitmq-console.${PHRASEA_DOMAIN}
      - TRAEFIK_CONSOLE_BASE_URL=https://traefik-console.${PHRASEA_DOMAIN}
      - ELASTICHQ_BASE_URL=https://elastichq.${PHRASEA_DOMAIN}
      - MAILHOG_BASE_URL=https://mailhog.${PHRASEA_DOMAIN}
      - SAML_BASE_URL=https://saml-idp.${PHRASEA_DOMAIN}
      - SAML2_BASE_URL=https://saml-idp2.${PHRASEA_DOMAIN}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.${PHRASEA_DOMAIN}`)"

  databox-api-php:
    profiles:
      - databox
    image: ${REGISTRY_NAMESPACE}databox-api-php:$DOCKER_TAG
    build:
      context: ./databox/api
      target: databox-api-php
    networks:
      internal:
        aliases:
          - databox-php
    environment:
      - APP_ENV
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - TRUSTED_PROXIES=${PS_SUBNET}
      - VERIFY_SSL
      - DATABOX_API_BASE_URL=https://api-databox.${PHRASEA_DOMAIN}
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - ADMIN_CLIENT_ID=${DATABOX_ADMIN_CLIENT_ID}
      - ADMIN_CLIENT_RANDOM_ID=${DATABOX_ADMIN_CLIENT_RANDOM_ID}
      - ADMIN_CLIENT_SECRET=${DATABOX_ADMIN_CLIENT_SECRET}
      - ELASTICSEARCH_URL
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${DATABOX_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${DATABOX_STORAGE_BUCKET_NAME}
      - DATABOX_REQUEST_SIGNATURE_TTL
      - PHRASEANET_BASE_URL
      - PHRASEANET_APP_OAUTH_TOKEN
      - UPLOAD_MAX_FILE_SIZE
      - DISPLAY_SERVICES_MENU
      - DASHBOARD_BASE_URL=https://dashboard.${PHRASEA_DOMAIN}
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=databox-api
    depends_on:
      - rabbitmq
      - redis
      - db
      - elasticsearch
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-uploader.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - phraseanet.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  databox-worker:
    profiles:
      - databox
    image: ${REGISTRY_NAMESPACE}databox-worker:$DOCKER_TAG
    build:
      context: ./databox/api
      target: databox-worker
    networks:
      - internal
    depends_on:
      - redis
      - rabbitmq
      - db
      - elasticsearch
    environment:
      - APP_ENV
      - AUTH_API_BASE_URL=https://api-auth.${PHRASEA_DOMAIN}
      - DATABOX_API_BASE_URL=https://api-databox.${PHRASEA_DOMAIN}
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
      - RABBITMQ_SSL
      - VERIFY_SSL
      - ADMIN_CLIENT_ID=${DATABOX_ADMIN_CLIENT_ID}
      - ADMIN_CLIENT_RANDOM_ID=${DATABOX_ADMIN_CLIENT_RANDOM_ID}
      - ADMIN_CLIENT_SECRET=${DATABOX_ADMIN_CLIENT_SECRET}
      - ELASTICSEARCH_URL
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_USE_PATH_STYLE_ENDPOINT=${DATABOX_STORAGE_USE_PATH_STYLE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${DATABOX_STORAGE_BUCKET_NAME}
      - DATABOX_REQUEST_SIGNATURE_TTL
      - PHRASEANET_BASE_URL
      - PHRASEANET_APP_OAUTH_TOKEN
      - NEWRELIC_ENABLED
      - NEWRELIC_LICENSE_KEY
      - NEWRELIC_APP_NAME=databox-worker
    extra_hosts:
      - api-auth.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-uploader.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - phraseanet.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  databox-api-nginx:
    profiles:
      - databox
    image: ${REGISTRY_NAMESPACE}databox-api-nginx:$DOCKER_TAG
    build:
      context: ./databox/api
      target: databox-api-nginx
    networks:
      internal:
        aliases:
          - databox-api
    environment:
      - UPLOAD_MAX_FILE_SIZE
    depends_on:
      - databox-api-php
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.databox-api.rule=Host(`api-databox.${PHRASEA_DOMAIN}`)"

  databox-indexer-app:
    image: ${REGISTRY_NAMESPACE}databox-indexer-app:$DOCKER_TAG
    build:
      context: ./databox/indexer-app
    profiles:
      - indexer-app
    privileged: true

  databox-indexer:
    image: ${REGISTRY_NAMESPACE}databox-indexer:$DOCKER_TAG
    command: [ "/bin/sh", "-c", "exit" ]
    build:
      context: ./databox/indexer
    profiles:
      - indexer
    networks:
      - internal
    environment:
      - AMQP_DSN=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/s3events
      - IMPORT_FILES=${INDEXER_IMPORT_FILES}
      - DATABOX_API_URL=https://api-databox.${PHRASEA_DOMAIN}
      - DATABOX_VERIFY_SSL=${VERIFY_SSL}
      - DATABOX_CLIENT_ID=${INDEXER_DATABOX_CLIENT_ID}_${INDEXER_DATABOX_CLIENT_RANDOM_ID}
      - DATABOX_CLIENT_SECRET=${INDEXER_DATABOX_CLIENT_SECRET}
      - DATABOX_CONCURRENCY=${INDEXER_DATABOX_CONCURRENCY}
      - DATABOX_WORKSPACE_SLUG=${INDEXER_DATABOX_WORKSPACE_SLUG}
      - DATABOX_OWNER_ID=${INDEXER_DATABOX_OWNER_ID}
      - PUBLIC_URL=https://databox-indexer.${PHRASEA_DOMAIN}
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${INDEXER_BUCKET_NAME}
      - BUCKET_NAMES=${INDEXER_BUCKET_NAME}
      - WATCH_DIR=${INDEXER_WATCH_DIR}
      - WATCH_DIR_PREFIX=${INDEXER_WATCH_DIR_PREFIX}
      - WATCH_SOURCE_DIR=${INDEXER_WATCH_SOURCE_DIR}
      - PHRASEANET_BASE_URL
      - PHRASEANET_APP_OAUTH_TOKEN
      - PHRASEANET_VERIFY_SSL=${VERIFY_SSL}
      - PHRASEANET_DATABOX_ID=${INDEXER_PHRASEANET_DATABOX_ID}
      - PHRASEANET_SEARCH_QUERY=${INDEXER_PHRASEANET_SEARCH_QUERY}
      - PHRASEANET_SEARCH_ORDER=${INDEXER_PHRASEANET_SEARCH_ORDER}
    volumes:
      - ${INDEXER_WATCH_SOURCE_DIR}:${INDEXER_WATCH_DIR}
    extra_hosts:
      - api-databox.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - phraseanet.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  databox-watcher:
    image: ${REGISTRY_NAMESPACE}databox-indexer:$DOCKER_TAG
    build:
      context: ./databox/indexer
    profiles:
      - indexer
    networks:
      - internal
    depends_on:
      - rabbitmq
    environment:
      - AMQP_DSN=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/s3events
      - IMPORT_FILES=${INDEXER_IMPORT_FILES}
      - DATABOX_API_URL=https://api-databox.${PHRASEA_DOMAIN}
      - DATABOX_VERIFY_SSL=${VERIFY_SSL}
      - DATABOX_CLIENT_ID=${INDEXER_DATABOX_CLIENT_ID}_${INDEXER_DATABOX_CLIENT_RANDOM_ID}
      - DATABOX_CLIENT_SECRET=${INDEXER_DATABOX_CLIENT_SECRET}
      - DATABOX_CONCURRENCY=${INDEXER_DATABOX_CONCURRENCY}
      - DATABOX_WORKSPACE_SLUG=${INDEXER_DATABOX_WORKSPACE_SLUG}
      - DATABOX_OWNER_ID=${INDEXER_DATABOX_OWNER_ID}
      - PUBLIC_URL=https://databox-indexer.${PHRASEA_DOMAIN}
      - S3_STORAGE_ENDPOINT=https://minio.${PHRASEA_DOMAIN}
      - S3_STORAGE_ACCESS_KEY
      - S3_STORAGE_SECRET_KEY
      - S3_STORAGE_REGION
      - S3_STORAGE_BUCKET_NAME=${INDEXER_BUCKET_NAME}
      - BUCKET_NAMES=${INDEXER_BUCKET_NAME}
      - WATCH_DIR=${INDEXER_WATCH_DIR}
      - WATCH_DIR_PREFIX=${INDEXER_WATCH_DIR_PREFIX}
      - WATCH_SOURCE_DIR=${INDEXER_WATCH_SOURCE_DIR}
      - PHRASEANET_BASE_URL
      - PHRASEANET_APP_OAUTH_TOKEN
      - PHRASEANET_VERIFY_SSL=${VERIFY_SSL}
      - PHRASEANET_DATABOX_ID=${INDEXER_PHRASEANET_DATABOX_ID}
    volumes:
      - ${INDEXER_WATCH_SOURCE_DIR}:${INDEXER_WATCH_DIR}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.databox-indexer.rule=Host(`databox-indexer.${PHRASEA_DOMAIN}`)"
    extra_hosts:
      - api-databox.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - phraseanet.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  elasticsearch:
    profiles:
      - databox
    image: elasticsearch:7.17.0
    networks:
      - internal
    volumes:
      - elasticsearch_vol:/usr/share/elasticsearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
    environment:
      - discovery.type=single-node
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"

  elastichq:
    profiles:
      - tools
    image: elastichq/elasticsearch-hq
    networks:
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.elastichq.rule=Host(`elastichq.${PHRASEA_DOMAIN}`)"
      - "traefik.http.routers.elastichq.middlewares=admin-secured@docker"

  k6:
    profiles:
      - loadtest
    image: grafana/k6:0.26.2
    networks:
      - internal
    command: '' # Manually run 'dc run --rm k6 run /scripts/src/main.js'
    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6
    volumes:
      - ./infra/load-test:/scripts
    extra_hosts:
      - expose.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-expose.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - databox.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - api-databox.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}
      - minio.${PHRASEA_DOMAIN}:${PS_GATEWAY_IP}

  influxdb:
    image: influxdb:1.8
    profiles:
      - loadtest
    networks:
      - internal
    environment:
      - INFLUXDB_DB=k6

  grafana:
    image: grafana/grafana:8.4.2
    profiles:
      - loadtest
    networks:
      - internal
    environment:
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_BASIC_ENABLED=false
    volumes:
      - ./infra/docker/grafana:/etc/grafana/provisioning
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${PHRASEA_DOMAIN}`)"
      - "traefik.http.routers.grafana.middlewares=admin-secured@docker"

  nginx-cache-purge:
    image: alchemyfr/nginx-cache-purge:1.0.0
    build:
      context: ./infra/docker/nginx-cache-purge
    networks:
      - internal

volumes:
  db_vol:
  redis_vol:
  uploader_vol: # rw-many
  s3_vol:
  matomo_vol:
  matomodb_vol:
  pgadmin_vol:
  rabbitmq_vol:
  elasticsearch_vol:
  expose_nginx_cache:
