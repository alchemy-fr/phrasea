name: Build, test and push

on: [push]

jobs:
  build:
    name: 'Build, Test and Push'
    runs-on: ubuntu-latest

    env:
      COMPOSE_PROJECT_NAME: build
      PS_SUBNET: 172.33.202.0/16
      PS_GATEWAY_IP: 172.33.0.1
      PHRASEA_DOMAIN: phrasea.local

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build
        run: |
          bin/build.sh

      - name: Setup
        run: |
          docker-compose down --volumes
          sudo PHRASEA_DOMAIN=${PHRASEA_DOMAIN} bin/dev/append-etc-hosts.sh
          bin/setup.sh

      - name: Test
        run: bin/test.sh

      - name: Clean containers
        if: ${{ always() }}
        run: |
          docker-compose down --volumes

      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push images
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        run: |
          function push() {
            local n=1
            local max=5
            local delay=10
            while true; do
              docker-compose \
                -f docker-compose.yml \
                -f docker-compose.prod.yml \
                -f docker-compose.report-elk.yml && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "Push failed. Attempt $n/$max:"
                  sleep $delay;
                else
                  echo "Push has failed after $n attempts." >&2
                  exit 1
                fi
              }
            done
          }
          if [[ -z "${DOCKERHUB_USERNAME}" ]]; then
            push
          else
            echo "Publish step skipped."
          fi
